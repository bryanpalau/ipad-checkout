<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Express | Batch & Remove</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; --panel: #1e293b; --danger: #ef4444; }
        
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        .header { padding: 10px; background: var(--panel); border-bottom: 1px solid #334155; flex-shrink: 0; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin: 0 auto; max-width: 400px; }
        .mode-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; color: #94a3b8; background: none; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        #reader { width: 100% !important; flex: 1; background: black; overflow: hidden; position: relative; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

        .overlay { padding: 20px; background: var(--panel); border-radius: 20px 20px 0 0; z-index: 10; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); flex-shrink: 0; }
        
        .user-info { display: flex; align-items: center; justify-content: space-between; font-size: 1.6rem; font-weight: bold; background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid var(--primary); }
        .qty-badge { background: var(--primary); color: white; padding: 4px 15px; border-radius: 20px; font-size: 1.2rem; }

        .status-banner { text-align: center; padding: 15px; border-radius: 10px; font-size: 1.6rem; font-weight: bold; margin-bottom: 10px; }
        .status-waiting { background: #334155; color: #cbd5e1; }
        .status-success { background: var(--success); color: white; }

        #historyList { 
            max-height: 40vh; /* Scaled for mobile view */
            overflow-y: auto; 
            background: #0f172a; 
            border: 2px solid #334155;
            border-radius: 12px; 
            margin-bottom: 15px; 
            display: none; 
        }

        .history-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 18px; 
            border-bottom: 1px solid #1e293b; 
            font-size: 1.4rem;
            font-weight: bold;
        }

        .btn-remove { 
            background: var(--danger); 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            font-size: 1.1rem; 
            cursor: pointer;
        }

        .footer-btns { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 18px; border-radius: 10px; border: none; background: #334155; color: white; font-size: 1.6rem; font-weight: bold; cursor: pointer; }
        .btn-finish { background: var(--primary); border: 2px solid #6366f1; }
        .btn-finish:disabled { opacity: 0.5; }
    </style>
</head>
<body>

<div class="header">
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div class="overlay">
    <div id="userPanel" class="user-info" style="display: none;">
        <div>User: <span id="currentUserId" style="color:var(--primary)">-</span></div>
        <div id="sessionCount" class="qty-badge">Qty: 0</div>
    </div>
    
    <div id="statusBanner" class="status-banner status-waiting">STEP 1: SCAN USER ID</div>
    
    <div id="historyList"></div>
    
    <div class="footer-btns">
        <button class="btn-action" onclick="toggleHistory()">Review List</button>
        <button id="finishBtn" class="btn-action btn-finish" onclick="finishSession()">Finish & Save</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'PASTE_YOUR_NEW_DEPLOYMENT_URL_HERE'; 
    
    let mode = 'borrow';
    let userId = null;
    let sessionHistory = [];
    let isProcessing = false;
    let html5QrCode;

    async function startScanner() {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 20, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        try {
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
                const backCam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
                await html5QrCode.start(backCam.id, config, onScanSuccess);
            }
        } catch (err) { console.error(err); }
    }

    function onScanSuccess(decodedText) {
        if (isProcessing) return;

        // User Scan
        if (!userId && decodedText.match(/^[ST]\d{3,10}$/i)) {
            userId = decodedText.toUpperCase();
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('currentUserId').innerText = userId;
            updateBanner("READY TO SCAN IPADS", "success");
            vibrate();
        } 
        // iPad Scan
        else if (userId && decodedText.match(/^iPad-\d{3,10}$/i)) {
            if (!sessionHistory.includes(decodedText)) {
                sessionHistory.push(decodedText);
                renderHistory();
                updateBanner("ADDED " + decodedText, "success");
                vibrate();
            }
        }
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        document.getElementById('sessionCount').innerText = "Qty: " + sessionHistory.length;
        
        if (sessionHistory.length > 0) {
            list.style.display = 'block';
            list.innerHTML = sessionHistory.map((id, index) => `
                <div class="history-item">
                    <span>${id}</span>
                    <button class="btn-remove" onclick="removeItem(${index})">Remove</button>
                </div>
            `).sort().join(''); // Optional sort for easier review
        } else {
            list.style.display = 'none';
        }
    }

    function removeItem(index) {
        sessionHistory.splice(index, 1);
        renderHistory();
        if (sessionHistory.length === 0) updateBanner("READY TO SCAN IPADS", "success");
    }

    async function finishSession() {
        if (!userId || sessionHistory.length === 0) return;
        
        isProcessing = true;
        const finishBtn = document.getElementById('finishBtn');
        finishBtn.disabled = true;
        updateBanner("SAVING TO SHEETS...", "waiting");

        try {
            // Note: using no-cors because Apps Script is a redirecting service
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: mode, userId: userId, ipadId: sessionHistory })
            });

            updateBanner("✅ ALL " + sessionHistory.length + " SAVED", "success");
            setTimeout(resetApp, 2000);
        } catch (e) {
            updateBanner("❌ SAVE ERROR", "waiting");
            finishBtn.disabled = false;
            isProcessing = false;
        }
    }

    function resetApp() {
        userId = null;
        sessionHistory = [];
        isProcessing = false;
        document.getElementById('finishBtn').disabled = false;
        document.getElementById('userPanel').style.display = 'none';
        renderHistory();
        updateBanner("STEP 1: SCAN USER ID", "waiting");
    }

    function toggleHistory() {
        const list = document.getElementById('historyList');
        const isHidden = (list.style.display === 'none' || list.style.display === '');
        list.style.display = isHidden ? 'block' : 'none';
        if (isHidden) list.scrollTop = 0;
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        resetApp();
    }

    function vibrate() { if (window.navigator.vibrate) window.navigator.vibrate(80); }

    startScanner();
</script>
</body>
</html>

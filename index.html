<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Multi-Scan Checkout</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header { padding: 10px; text-align: center; background: var(--panel); border-bottom: 1px solid #334155; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin: 5px auto; max-width: 300px; }
        .mode-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; color: #94a3b8; background: none; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        #reader { width: 100%; flex-grow: 1; background: black; }
        
        .overlay { padding: 15px; background: var(--panel); border-radius: 20px 20px 0 0; position: relative; z-index: 10; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        .user-info { display: flex; align-items: center; justify-content: space-between; background: #0f172a; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--primary); }
        .user-id-text { font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        .change-user { font-size: 0.8rem; color: #94a3b8; text-decoration: underline; cursor: pointer; }

        .status-banner { text-align: center; padding: 12px; border-radius: 8px; font-weight: bold; margin-bottom: 10px; transition: all 0.3s; }
        .status-waiting { background: #334155; color: #cbd5e1; }
        .status-success { background: var(--success); color: white; animation: pulse 0.5s; }

        .scan-count { font-size: 0.9rem; color: #94a3b8; text-align: center; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div class="overlay">
    <div id="userPanel" class="user-info" style="display: none;">
        <div>User: <span id="currentUserId" class="user-id-text">-</span></div>
        <div class="change-user" onclick="resetUser()">Change User</div>
    </div>

    <div id="statusBanner" class="status-banner status-waiting">
        STEP 1: SCAN USER ID
    </div>

    <div id="scanCount" class="scan-count">No iPads scanned in this session</div>
</div>

<script>
    const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE';
    
    let mode = 'borrow';
    let userId = null;
    let scanCount = 0;
    let isProcessing = false;

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 20, qrbox: { width: 250, height: 250 } };

    // Camera Init
    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length > 0) {
            const backCam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
            html5QrCode.start(backCam.id, config, onScanSuccess);
        }
    });

    function onScanSuccess(decodedText) {
        if (isProcessing) return;

        // Feedback: Vibration
        if (window.navigator.vibrate) window.navigator.vibrate(100);

        if (!userId) {
            // STEP 1: Identify User
            if (decodedText.match(/^[ST]\d{3,5}$/i)) {
                userId = decodedText.toUpperCase();
                showUserPanel();
                triggerFeedback("USER RECOGNIZED", "success");
            }
        } else {
            // STEP 2: Multi-iPad Scanning
            if (decodedText.match(/^iPad-\d{3,5}$/i)) {
                submitIpad(decodedText);
            }
        }
    }

    async function submitIpad(ipadId) {
        isProcessing = true;
        const banner = document.getElementById('statusBanner');
        banner.innerText = "SAVING " + ipadId + "...";
        banner.className = "status-banner status-waiting";

        try {
            // Send to Google Sheets
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({
                    action: mode,
                    userId: userId,
                    ipadId: ipadId
                })
            });

            // SUCCESS FEEDBACK
            scanCount++;
            document.getElementById('scanCount').innerText = "Session Count: " + scanCount + " iPads";
            triggerFeedback("✅ " + ipadId + " SAVED", "success");
            
            // Short cooldown to move to next iPad
            setTimeout(() => { isProcessing = false; }, 1000);
        } catch (e) {
            triggerFeedback("❌ CONNECTION ERROR", "waiting");
            isProcessing = false;
        }
    }

    function triggerFeedback(text, type) {
        const banner = document.getElementById('statusBanner');
        banner.innerText = text;
        banner.className = "status-banner status-" + type;
        
        // Reset color after a moment if it's a success message
        if (type === 'success' && userId) {
            setTimeout(() => {
                if (isProcessing) return;
                banner.innerText = "READY FOR NEXT IPAD";
                banner.className = "status-banner status-waiting";
            }, 2000);
        }
    }

    function showUserPanel() {
        document.getElementById('userPanel').style.display = 'flex';
        document.getElementById('currentUserId').innerText = userId;
        document.getElementById('statusBanner').innerText = "READY TO SCAN IPADS";
    }

    function resetUser() {
        userId = null;
        scanCount = 0;
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('scanCount').innerText = "No iPads scanned in this session";
        triggerFeedback("STEP 1: SCAN USER ID", "waiting");
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        resetUser();
    }
</script>
</body>
</html>

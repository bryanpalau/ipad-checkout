<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Express | Batch Fixed</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 10px; background: var(--panel); border-bottom: 1px solid #334155; flex-shrink: 0; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin: 0 auto; max-width: 400px; }
        .mode-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; color: #94a3b8; background: none; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }
        #reader { width: 100% !important; flex: 1; background: black; overflow: hidden; position: relative; }
        #reader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }
        .overlay { padding: 20px; background: var(--panel); border-radius: 20px 20px 0 0; z-index: 10; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); flex-shrink: 0; }
        .user-info { display: flex; align-items: center; justify-content: space-between; font-size: 1.6rem; font-weight: bold; background: #0f172a; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 2px solid var(--primary); }
        .status-banner { text-align: center; padding: 15px; border-radius: 10px; font-size: 1.6rem; font-weight: bold; margin-bottom: 10px; }
        .status-waiting { background: #334155; color: #cbd5e1; }
        .status-success { background: var(--success); color: white; }
        .status-error { background: #ef4444; color: white; }
        #historyList { max-height: 120px; overflow-y: auto; background: #0f172a; border-radius: 8px; margin-bottom: 10px; display: none; }
        .history-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #1e293b; font-size: 1.1rem; }
        .footer-btns { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 16px; border-radius: 10px; border: none; background: #334155; color: white; font-size: 1.6rem; font-weight: bold; cursor: pointer; }
        .btn-finish { background: var(--primary); }
        .btn-finish:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="header">
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div class="overlay">
    <div id="userPanel" class="user-info" style="display: none;">
        <div>User: <span id="currentUserId" style="color:var(--primary)">-</span></div>
        <div id="sessionCount" style="color: #94a3b8;">Qty: 0</div>
    </div>
    
    <div id="statusBanner" class="status-banner status-waiting">STEP 1: SCAN USER ID</div>
    
    <div id="historyList"></div>
    
    <div class="footer-btns">
        <button class="btn-action" onclick="toggleHistory()">Review</button>
        <button id="finishBtn" class="btn-action btn-finish" onclick="finishSession()">Finish & Save</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'YOUR_WEB_APP_URL_HERE'; 
    
    let mode = 'borrow';
    let userId = null;
    let sessionHistory = [];
    let isProcessing = false;
    let html5QrCode;

    async function startScanner() {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 20, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        try {
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
                const backCam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
                await html5QrCode.start(backCam.id, config, onScanSuccess);
            }
        } catch (err) { console.error(err); }
    }

    function onScanSuccess(decodedText) {
        if (isProcessing) return;

        // User ID Scan
        if (!userId && decodedText.match(/^[ST]\d{3,10}$/i)) {
            if (window.navigator.vibrate) window.navigator.vibrate(80);
            userId = decodedText.toUpperCase();
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('currentUserId').innerText = userId;
            updateBanner("READY TO SCAN IPADS", "success");
        } 
        // iPad Scan
        else if (userId && decodedText.match(/^iPad-\d{3,10}$/i)) {
            if (!sessionHistory.includes(decodedText)) {
                if (window.navigator.vibrate) window.navigator.vibrate(80);
                sessionHistory.push(decodedText);
                updateUI(decodedText);
                updateBanner("ADDED " + decodedText, "success");
            }
        }
    }

    async function finishSession() {
        if (!userId || sessionHistory.length === 0) return;
        
        isProcessing = true;
        const btn = document.getElementById('finishBtn');
        btn.disabled = true;
        updateBanner("SAVING TO SHEETS...", "waiting");

        try {
            // Sending the array 'sessionHistory' to the backend
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: mode, userId: userId, ipadId: sessionHistory })
            });

            updateBanner("✅ ALL SAVED SUCCESSFULLY", "success");
            setTimeout(resetApp, 2000);
        } catch (e) {
            updateBanner("❌ ERROR SAVING", "error");
            btn.disabled = false;
            isProcessing = false;
        }
    }

    function resetApp() {
        userId = null;
        sessionHistory = [];
        isProcessing = false;
        document.getElementById('finishBtn').disabled = false;
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('historyList').innerHTML = '';
        document.getElementById('historyList').style.display = 'none';
        document.getElementById('sessionCount').innerText = "Qty: 0";
        updateBanner("STEP 1: SCAN USER ID", "waiting");
    }

    function updateUI(ipadId) {
        document.getElementById('sessionCount').innerText = "Qty: " + sessionHistory.length;
        const list = document.getElementById('historyList');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<span>${ipadId}</span><span>Pending</span>`;
        list.prepend(item);
        list.style.display = 'block';
    }

    function updateBanner(text, type) {
        const banner = document.getElementById('statusBanner');
        banner.innerText = text;
        banner.className = "status-banner status-" + type;
    }

    function toggleHistory() {
        const list = document.getElementById('historyList');
        list.style.display = (list.style.display === 'none') ? 'block' : 'none';
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        resetApp();
    }

    startScanner();
</script>
</body>
</html>

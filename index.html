<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Fast-Scan Checkout</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header & Mode Switch */
        .header { padding: 15px; text-align: center; background: #1e293b; border-bottom: 1px solid #334155; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin-top: 10px; }
        .mode-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; color: #94a3b8; background: none; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        /* Scanner Area */
        #reader { width: 100%; flex-grow: 1; background: black; }
        
        /* Progress Overlay */
        .overlay { padding: 20px; background: #1e293b; border-radius: 20px 20px 0 0; position: relative; z-index: 10; }
        .step-container { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .step { flex: 1; text-align: center; padding: 10px; border-bottom: 4px solid #334155; color: #64748b; font-weight: bold; transition: 0.3s; }
        .step.active { border-color: var(--primary); color: white; }
        .step.complete { border-color: var(--success); color: var(--success); }

        .status-text { text-align: center; font-size: 1.1rem; margin-top: 5px; min-height: 1.5rem; }
        #log-summary { font-size: 0.8rem; color: #94a3b8; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 1.2rem; font-weight: 800; letter-spacing: 1px;">IPAD EXPRESS</div>
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div class="overlay">
    <div class="step-container">
        <div id="step1" class="step active">1. SCAN USER</div>
        <div id="step2" class="step">2. SCAN IPAD</div>
    </div>
    <div id="status" class="status-text">Position QR code in camera view</div>
    <div id="log-summary">Ready to scan...</div>
</div>

<script>
    // 1. UPDATE WITH YOUR WEB APP URL
    const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE';
    
    let mode = 'borrow';
    let userId = null;
    let ipadId = null;
    let isProcessing = false;

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 20, qrbox: { width: 250, height: 250 } };

    // Start Scanner
    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length > 0) {
            const backCam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
            html5QrCode.start(backCam.id, config, onScanSuccess);
        }
    });

    function onScanSuccess(decodedText) {
        if (isProcessing) return;

        // Feedback
        if (window.navigator.vibrate) window.navigator.vibrate(100);

        if (!userId) {
            // Validate User ID format (S001 or T001)
            if (decodedText.match(/^[ST]\d{3,5}$/i)) {
                userId = decodedText.toUpperCase();
                document.getElementById('step1').className = 'step complete';
                document.getElementById('step2').className = 'step active';
                document.getElementById('status').innerText = "User: " + userId;
                document.getElementById('log-summary').innerText = "Now scan the iPad QR code";
                // Short delay to prevent accidental double-scan
                isProcessing = true;
                setTimeout(() => { isProcessing = false; }, 1500);
            }
        } else if (!ipadId) {
            // Validate iPad ID format (iPad-001)
            if (decodedText.match(/^iPad-\d{3,5}$/i)) {
                ipadId = decodedText;
                document.getElementById('step2').className = 'step complete';
                submitData();
            }
        }
    }

    async function submitData() {
        isProcessing = true;
        document.getElementById('status').innerText = "⏳ Saving to Google Sheets...";
        
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                body: JSON.stringify({
                    action: mode,
                    userId: userId,
                    ipadId: ipadId
                })
            });

            document.getElementById('status').style.color = '#10b981';
            document.getElementById('status').innerText = "✅ SUCCESS: " + ipadId;
            setTimeout(reset, 2000);
        } catch (e) {
            alert("Connection Error. Check internet.");
            reset();
        }
    }

    function reset() {
        userId = null;
        ipadId = null;
        isProcessing = false;
        document.getElementById('status').style.color = 'white';
        document.getElementById('status').innerText = "Position QR code in camera view";
        document.getElementById('step1').className = 'step active';
        document.getElementById('step2').className = 'step';
        document.getElementById('log-summary').innerText = "Last Session Complete.";
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        reset();
    }
</script>
</body>
</html>

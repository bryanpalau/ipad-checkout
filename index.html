<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Express | No-Freeze Multi-Scan</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; --panel: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { padding: 10px; text-align: center; background: var(--panel); border-bottom: 1px solid #334155; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 8px; padding: 4px; margin: 5px auto; max-width: 400px; }
        .mode-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; color: #94a3b8; background: none; font-size: 2rem; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }
        
        /* Updated reader style to ensure video centers correctly */
        #reader { width: 100%; flex-grow: 1; background: black; overflow: hidden; }
        #reader video { object-fit: cover; }

        .overlay { padding: 15px; background: var(--panel); border-radius: 20px 20px 0 0; position: relative; z-index: 10; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        .user-info { display: flex; align-items: center; justify-content: space-between; background: #0f172a; padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid var(--primary); }
        .status-banner { text-align: center; padding: 12px; border-radius: 8px; font-size: 2rem; font-weight: bold; margin-bottom: 10px; transition: all 0.3s; }
        .status-waiting { background: #334155; color: #cbd5e1; }
        .status-success { background: var(--success); color: white; }
        #historyList { max-height: 80px; overflow-y: auto; background: #0f172a; border-radius: 8px; padding: 5px; margin-top: 5px; font-size: 0.85rem; display: none; }
        .history-item { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px solid #1e293b; }
        .footer-btns { display: flex; gap: 10px; margin-top: 10px; font-size: 2rem; }
        .btn-action { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 2rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div class="overlay">
    <div id="userPanel" class="user-info" style="display: none;">
        <div>User: <span id="currentUserId" style="font-weight:bold; color:var(--primary)">-</span></div>
        <div id="sessionCount" style="font-size: 2rem; color: #94a3b8;">Count: 0</div>
    </div>
    <div id="statusBanner" class="status-banner status-waiting">STEP 1: SCAN USER ID</div>
    <div id="historyList"></div>
    <div class="footer-btns">
        <button class="btn-action" onclick="toggleHistory()">Review</button>
        <button class="btn-action" style="background: #ef4444;" onclick="finishSession()">FINISH</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxK3sUhT-pA5rmsrkEMLUpnweznpbz9mTrn564UVU74vZGQV72oy5baQxuLdTzNjPaECw/exec';
    
    let mode = 'borrow';
    let userId = null;
    let sessionHistory = [];
    let isProcessing = false;
    let html5QrCode;

    async function startScanner() {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        
        // Function to calculate a smaller, responsive scan area
        const qrBoxSize = (viewfinderWidth, viewfinderHeight) => {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            let size = Math.floor(minEdge * 0.6); // 60% of the smaller edge
            return { width: size, height: size };
        };

        const config = { 
            fps: 20, 
            qrbox: qrBoxSize, // Applied the smaller box function
            aspectRatio: 1.0  // Forces square aspect ratio for better focus
        };

        try {
            const cameras = await Html5Qrcode.getCameras();
            if (cameras && cameras.length > 0) {
                const backCam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
                await html5QrCode.start(backCam.id, config, onScanSuccess);
            }
        } catch (err) { console.error("Scanner error:", err); }
    }

    function onScanSuccess(decodedText) {
        if (isProcessing) return;
        if (window.navigator.vibrate) window.navigator.vibrate(100);

        if (!userId) {
            if (decodedText.match(/^[ST]\d{3,5}$/i)) {
                userId = decodedText.toUpperCase();
                document.getElementById('userPanel').style.display = 'flex';
                document.getElementById('currentUserId').innerText = userId;
                updateBanner("READY TO SCAN IPADS", "success");
            }
        } else {
            if (decodedText.match(/^iPad-\d{3,5}$/i)) {
                submitIpad(decodedText);
            }
        }
    }

    async function submitIpad(ipadId) {
        if (sessionHistory.includes(ipadId)) {
            updateBanner("ALREADY SCANNED: " + ipadId, "waiting");
            return;
        }
        isProcessing = true;
        updateBanner("SAVING " + ipadId + "...", "waiting");

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: mode, userId: userId, ipadId: ipadId })
            });

            sessionHistory.push(ipadId);
            updateUI(ipadId);
            updateBanner("✅ " + ipadId + " CHECKED", "success");
            setTimeout(() => { isProcessing = false; }, 1200);
        } catch (e) {
            updateBanner("❌ CONNECTION ERROR", "waiting");
            isProcessing = false;
        }
    }

    function updateUI(ipadId) {
        document.getElementById('sessionCount').innerText = "Count: " + sessionHistory.length;
        const list = document.getElementById('historyList');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<span>${ipadId}</span><span>${new Date().toLocaleTimeString()}</span>`;
        list.prepend(item);
    }

    function updateBanner(text, type) {
        const banner = document.getElementById('statusBanner');
        banner.innerText = text;
        banner.className = "status-banner status-" + type;
    }

    function toggleHistory() {
        const list = document.getElementById('historyList');
        list.style.display = (list.style.display === 'none') ? 'block' : 'none';
    }

    function finishSession() {
        userId = null;
        sessionHistory = [];
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('historyList').innerHTML = '';
        document.getElementById('sessionCount').innerText = "Count: 0";
        updateBanner("STEP 1: SCAN USER ID", "waiting");
        isProcessing = false; 
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        finishSession();
    }

    startScanner();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Multi-Scan Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --bg: #0f172a; --card: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Compact Header */
        .header { padding: 10px; background: var(--card); border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .mode-toggle { display: flex; background: #0f172a; border-radius: 6px; padding: 2px; }
        .mode-btn { padding: 6px 15px; border: none; border-radius: 4px; color: #94a3b8; background: none; font-size: 0.8rem; font-weight: bold; cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        /* Smaller Scanning Area (30% height) */
        #reader { width: 100%; height: 35vh !important; background: black; }
        
        /* Feedback Panel (Top & Bottom focus) */
        .panel { flex-grow: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .status-card { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border-left: 5px solid var(--primary); }
        .user-info { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        
        /* Success Banner - Visual Alert */
        #feedbackToast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--success); color: white; padding: 20px 40px; border-radius: 50px;
            font-weight: bold; font-size: 1.5rem; display: none; z-index: 1000;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
        }

        .btn-finish { background: #64748b; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: auto; }
        
        .history-list { font-size: 0.85rem; color: #94a3b8; }
        .history-item { padding: 8px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: 800; font-size: 0.9rem;">IPAD SCANNER</div>
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader"></div>

<div id="feedbackToast">✅ SCAN SUCCESS</div>

<div class="panel">
    <div class="status-card">
        <div id="instruction" style="font-size: 0.9rem; color: #94a3b8;">STEP 1</div>
        <div id="displayMain" class="user-info">SCAN USER ID</div>
        <div id="displaySub" style="font-size: 0.8rem;">Waiting for first scan...</div>
    </div>

    <div style="font-weight: bold; font-size: 0.8rem; color: #64748b;">SESSION HISTORY</div>
    <div id="history" class="history-list"></div>

    <button class="btn-finish" onclick="resetSession()">DONE / NEW USER</button>
</div>

<script>
    const SCRIPT_URL = 'YOUR_GOOGLE_SCRIPT_URL_HERE'; // MUST BE UPDATED
    
    let mode = 'borrow';
    let userId = null;
    let isProcessing = false;

    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 20, qrbox: 200 };

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length > 0) {
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
        }
    });

    function onScanSuccess(decodedText) {
        if (isProcessing) return;

        if (!userId) {
            // First Scan: User ID
            if (decodedText.match(/^[ST]\d{3,5}$/i)) {
                userId = decodedText.toUpperCase();
                showFeedback("USER OK");
                updateUI("STEP 2: SCAN IPADS", userId, "Scan as many iPads as needed");
                isProcessing = true;
                setTimeout(() => isProcessing = false, 1500); // Lock to prevent repeat
            }
        } else {
            // Consecutive Scans: iPad IDs
            if (decodedText.match(/^iPad-\d{3,5}$/i)) {
                const ipadId = decodedText;
                showFeedback("IPAD OK");
                submitData(ipadId);
                isProcessing = true;
                setTimeout(() => isProcessing = false, 1500);
            }
        }
    }

    function showFeedback(msg) {
        if (window.navigator.vibrate) window.navigator.vibrate(200);
        const toast = document.getElementById('feedbackToast');
        toast.innerText = "✅ " + msg;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 800);
    }

    async function submitData(ipadId) {
        const history = document.getElementById('history');
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<span>${ipadId}</span><span style="color:#64748b">Saving...</span>`;
        history.prepend(item);

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: mode, userId: userId, ipadId: ipadId })
            });
            item.innerHTML = `<span>${ipadId}</span><span style="color:var(--success)">✓ Recorded</span>`;
        } catch (e) {
            item.innerHTML = `<span>${ipadId}</span><span style="color:red">ERROR</span>`;
        }
    }

    function updateUI(instr, main, sub) {
        document.getElementById('instruction').innerText = instr;
        document.getElementById('displayMain').innerText = main;
        document.getElementById('displaySub').innerText = sub;
    }

    function resetSession() {
        userId = null;
        document.getElementById('history').innerHTML = '';
        updateUI("STEP 1", "SCAN USER ID", "Waiting for first scan...");
    }

    function setMode(m) {
        mode = m;
        document.getElementById('btnBorrow').classList.toggle('active', m === 'borrow');
        document.getElementById('btnReturn').classList.toggle('active', m === 'return');
        resetSession();
    }
</script>
</body>
</html>

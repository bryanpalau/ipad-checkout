<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Express Checkout</title>
    <!-- Fixed: Use specific version for stability -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        :root { 
            --primary: #4f46e5; 
            --success: #10b981; 
            --bg: #0f172a; 
            --panel: #1e293b; 
            --danger: #ef4444; 
            --gray: #334155;
            --warning: #f59e0b;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden;
            /* iOS Safari optimization */
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .header { 
            padding: 10px; 
            background: var(--panel); 
            border-bottom: 1px solid var(--gray); 
            flex-shrink: 0; 
        }
        
        .mode-toggle { 
            display: flex; 
            background: #0f172a; 
            border-radius: 8px; 
            padding: 4px; 
            margin: 0 auto; 
            max-width: 400px; 
        }
        
        .mode-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            color: #94a3b8; 
            background: none; 
            font-size: 1.1rem; 
            font-weight: bold; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        
        .mode-btn.active { 
            background: var(--primary); 
            color: white; 
        }
        
        /* Fixed: Explicit dimensions for scanner */
        #reader-container {
            width: 100%;
            max-width: 500px;
            margin: 10px auto 0;
            flex-shrink: 0;
            position: relative;
        }
        
        #reader { 
            width: 100% !important; 
            height: 280px !important;
            background: black; 
            border-radius: 12px; 
            overflow: hidden; 
            border: 2px solid var(--gray);
            position: relative;
        }
        
        /* Fixed: Ensure video fills container */
        #reader video { 
            width: 100% !important; 
            height: 100% !important; 
            object-fit: cover !important;
        }
        
        /* New: Scan overlay indicator */
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 3px solid var(--success);
            border-radius: 12px;
            pointer-events: none;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.3; }
        }
        
        .scan-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--success);
        }
        
        .scan-corner.tl { top: 0; left: 0; border-right: none; border-bottom: none; }
        .scan-corner.tr { top: 0; right: 0; border-left: none; border-bottom: none; }
        .scan-corner.bl { bottom: 0; left: 0; border-right: none; border-top: none; }
        .scan-corner.br { bottom: 0; right: 0; border-left: none; border-top: none; }

        .overlay { 
            padding: 20px; 
            background: var(--panel); 
            border-radius: 24px 24px 0 0; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5); 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        .status-banner { 
            text-align: center; 
            padding: 15px; 
            border-radius: 10px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            flex-shrink: 0;
            font-size: 0.95rem;
        }
        
        .status-waiting { background: var(--gray); color: #cbd5e1; }
        .status-success { background: var(--success); color: white; border: 2px solid #6ee7b7; }
        .status-error { background: var(--danger); color: white; }
        .status-warning { background: var(--warning); color: white; }
        
        #userPanel {
            display: none;
            justify-content: space-between;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
            flex-shrink: 0;
        }
        
        #historyList { 
            flex-grow: 1; 
            overflow-y: auto; 
            background: #0f172a; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            border: 1px solid var(--gray);
            display: none; 
        }
        
        .action-bar { 
            display: flex; 
            gap: 10px; 
            align-items: stretch; 
            height: 60px; 
            flex-shrink: 0; 
        }
        
        .btn-action { 
            flex: 1; 
            border-radius: 12px; 
            border: none; 
            background: var(--gray); 
            color: white; 
            font-size: 1rem; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: 0.2s; 
        }
        
        .btn-finish { background: var(--primary); }
        .btn-clear { background: #475569; }
        
        .btn-action:active { 
            opacity: 0.7; 
            transform: scale(0.98); 
        }
        
        .btn-finish:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }

        .delete-btn { 
            background: rgba(239, 68, 68, 0.2); 
            color: #ff8080; 
            border: 1px solid var(--danger); 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-weight: bold; 
            font-size: 0.75rem; 
            cursor: pointer; 
        }
        
        /* New: Loading spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            #reader { height: 220px !important; }
            .overlay { padding: 15px; }
            .mode-btn { font-size: 0.9rem; padding: 10px; }
            .action-bar { height: 50px; gap: 5px; }
            .btn-action { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="mode-toggle">
        <button id="btnBorrow" class="mode-btn active" onclick="setMode('borrow')">BORROW</button>
        <button id="btnReturn" class="mode-btn" onclick="setMode('return')">RETURN</button>
    </div>
</div>

<div id="reader-container">
    <div id="reader"></div>
    <div class="scan-overlay">
        <div class="scan-corner tl"></div>
        <div class="scan-corner tr"></div>
        <div class="scan-corner bl"></div>
        <div class="scan-corner br"></div>
    </div>
</div>

<div class="overlay">
    <div id="userPanel">
        <span>User: <b id="currentUserId" style="color:var(--primary)">-</b></span>
        <span id="sessionCount">Qty: 0</span>
    </div>
    
    <div id="statusBanner" class="status-banner status-waiting">INITIALIZING...</div>
    
    <div id="historyList"></div>

    <div class="action-bar">
        <button class="btn-action btn-clear" onclick="clearAll()">Clear All</button>
        <button class="btn-action" onclick="toggleHistory()">Review</button>
        <button id="finishBtn" class="btn-action btn-finish" onclick="finishSession()">Finish & Save</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    // IMPORTANT: Replace with your actual Google Apps Script deployment URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzQ7_1zLhvqysUfCONXkXHF_ymA9NubRDD-AA3gitXsEVg_-ElgQiH_fMk-O8lpHjBTA/exec';
    
    // Debug mode - set to false for production
    const DEBUG_MODE = true;

    let mode = 'borrow';
    let userId = null;
    let sessionHistory = [];
    let isProcessing = false;
    let unavailableIpads = [];
    let lastScanned = null;
    let lastScanTime = 0;
    let html5QrCode = null;
    let scannerStarted = false;

    // Audio context initialization (iOS requires user interaction)
    let audioCtx = null;
    
    function initAudioContext() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        // iOS Safari requires resume after user interaction
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }
    
    function playBeep(f, d) {
        try {
            initAudioContext();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g);
            g.connect(audioCtx.destination);
            o.frequency.value = f;
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d/1000);
            o.start();
            o.stop(audioCtx.currentTime + d/1000);
        } catch (e) {
            if (DEBUG_MODE) console.log('Audio error (non-critical):', e);
        }
    }

    function playError() {
        try {
            initAudioContext();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(300, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.3);
            o.connect(g);
            g.connect(audioCtx.destination);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);
            o.start();
            o.stop(audioCtx.currentTime + 0.3);
        } catch (e) {
            if (DEBUG_MODE) console.log('Audio error (non-critical):', e);
        }
    }

    // Fixed: Enhanced syncBorrowedList with error handling and retry
    async function syncBorrowedList(retryCount = 0) {
        const maxRetries = 3;
        try {
            if (DEBUG_MODE) console.log('Syncing borrowed list...');
            
            const resp = await fetch(SCRIPT_URL, {
                method: 'GET',
                cache: 'no-cache'
            });
            
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            
            const data = await resp.json();
            
            if (DEBUG_MODE) console.log('Sync response:', data);
            
            if (data.success && data.borrowed) {
                unavailableIpads = data.borrowed;
                updateBanner("STEP 1: SCAN USER ID", "status-waiting");
                if (DEBUG_MODE) console.log('Unavailable iPads:', unavailableIpads);
            } else {
                throw new Error('Invalid response format');
            }
        } catch (e) {
            console.error("Sync Failed:", e);
            
            if (retryCount < maxRetries) {
                if (DEBUG_MODE) console.log(`Retrying sync (${retryCount + 1}/${maxRetries})...`);
                setTimeout(() => syncBorrowedList(retryCount + 1), 1000 * (retryCount + 1));
            } else {
                updateBanner("OFFLINE MODE - SCAN USER ID", "status-warning");
                unavailableIpads = []; // Allow scanning in offline mode
            }
        }
    }

    // Fixed: Improved scanner initialization with iOS Safari compatibility
    async function startScanner() {
        try {
            if (DEBUG_MODE) console.log('Starting scanner...');
            updateBanner("STARTING CAMERA...", "status-waiting");
            
            // Create scanner instance
            html5QrCode = new Html5Qrcode("reader");
            
            // Configuration optimized for QR codes
            const config = { 
                fps: 10, // Lower FPS for iOS stability
                qrbox: { width: 250, height: 250 }, // Larger scan area
                aspectRatio: 1.0,
                formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
            };
            
            // Request camera permissions explicitly
            const devices = await Html5Qrcode.getCameras();
            if (DEBUG_MODE) console.log('Available cameras:', devices);
            
            if (devices && devices.length === 0) {
                throw new Error('No cameras found');
            }
            
            // Start scanner with rear camera
            await html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                onScanSuccess,
                onScanFailure
            );
            
            scannerStarted = true;
            if (DEBUG_MODE) console.log('Scanner started successfully');
            
            // Sync borrowed list after scanner is ready
            await syncBorrowedList();
            
        } catch (err) {
            console.error('Scanner initialization error:', err);
            updateBanner("CAMERA ERROR - TAP TO RETRY", "status-error");
            
            // Add retry button
            document.getElementById('statusBanner').onclick = () => {
                document.getElementById('statusBanner').onclick = null;
                startScanner();
            };
        }
    }

    // Fixed: Enhanced scan success handler with better pattern matching
    function onScanSuccess(decodedText, decodedResult) {
        const now = Date.now();
        const cleanData = decodedText.trim().toUpperCase(); // Force uppercase
        
        if (DEBUG_MODE) {
            console.log('QR Scanned:', cleanData);
            console.log('Current userId:', userId);
            console.log('Current mode:', mode);
        }
        
        // Debounce duplicate scans
        if (cleanData === lastScanned && (now - lastScanTime) < 2000) {
            if (DEBUG_MODE) console.log('Duplicate scan ignored (debounced)');
            return;
        }
        
        if (isProcessing) {
            if (DEBUG_MODE) console.log('Scan ignored (processing)');
            return;
        }

        // User ID Recognition - Pattern: S001, T001, etc.
        const userPattern = /^[ST]\d{3,}$/i;
        if (!userId && userPattern.test(cleanData)) {
            userId = cleanData;
            lastScanned = cleanData;
            lastScanTime = now;
            
            document.getElementById('userPanel').style.display = 'flex';
            document.getElementById('currentUserId').innerText = userId;
            updateBanner("✓ USER SCANNED - NOW SCAN IPADS", "status-success");
            playBeep(880, 200);
            
            if (DEBUG_MODE) console.log('User ID set:', userId);
        } 
        // iPad ID Recognition - Pattern: iPad-001, iPad-002, etc.
        else if (userId && /^IPAD-\d{3,}$/i.test(cleanData)) {
            
            // Check if iPad is blocked by admin
            if (mode === 'borrow' && unavailableIpads.includes(cleanData)) {
                updateBanner("❌ ALREADY BORROWED", "status-error");
                playError();
                if (DEBUG_MODE) console.log('iPad already borrowed:', cleanData);
                return;
            }
            
            // Check if already in current session
            if (sessionHistory.includes(cleanData)) {
                updateBanner("⚠️ ALREADY IN SESSION", "status-warning");
                playError();
                if (DEBUG_MODE) console.log('iPad already in session:', cleanData);
            } else {
                sessionHistory.push(cleanData);
                lastScanned = cleanData;
                lastScanTime = now;
                renderHistory();
                updateBanner("✓ ADDED " + cleanData, "status-success");
                playBeep(660, 100);
                
                if (DEBUG_MODE) console.log('iPad added to session:', cleanData);
            }
        } 
        // Invalid scan
        else {
            playError();
            if (!userId) {
                updateBanner("❌ SCAN USER ID FIRST", "status-error");
                if (DEBUG_MODE) console.log('No user ID yet, scanned:', cleanData);
            } else {
                updateBanner("❌ INVALID QR CODE", "status-error");
                if (DEBUG_MODE) console.log('Invalid QR code format:', cleanData);
            }
        }
    }

    // New: Scan failure handler (called on every frame without successful scan)
    function onScanFailure(error) {
        // Don't log every frame failure - too verbose
        // Only log actual errors
        if (error && !error.includes('No MultiFormat Readers')) {
            if (DEBUG_MODE) console.log('Scan error:', error);
        }
    }

    function clearAll() {
        if (sessionHistory.length === 0) return;
        if (confirm("Clear all scanned iPads and start over?")) {
            sessionHistory = [];
            renderHistory();
            document.getElementById('historyList').style.display = 'none';
            updateBanner("LIST CLEARED", "status-waiting");
        }
    }

    // Enhanced: Improved finish session with better error handling
    async function finishSession() {
        if (!userId || sessionHistory.length === 0 || isProcessing) return;
        
        isProcessing = true;
        document.getElementById('finishBtn').disabled = true;
        updateBanner("SAVING TO CLOUD...", "status-warning");

        const payload = {
            action: mode,
            userId: userId,
            ipadId: sessionHistory
        };

        if (DEBUG_MODE) console.log('Sending payload:', payload);

        const maxRetries = 3;
        let lastError = null;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors' // Changed from no-cors for better error handling
                });

                if (DEBUG_MODE) console.log('Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    if (DEBUG_MODE) console.log('Response data:', result);
                    
                    if (result.success) {
                        updateBanner("✅ SUCCESS: DATA SAVED", "status-success");
                        playBeep(1100, 400);
                        setTimeout(resetApp, 2500);
                        return; // Success - exit function
                    } else {
                        throw new Error(result.error || 'Server returned error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (err) {
                console.error(`Attempt ${attempt} failed:`, err);
                lastError = err;
                
                if (attempt < maxRetries) {
                    updateBanner(`RETRY ${attempt}/${maxRetries}...`, "status-warning");
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
        }
        
        // All retries failed
        playError();
        updateBanner("❌ SAVE FAILED - TAP TO RETRY", "status-error");
        isProcessing = false;
        document.getElementById('finishBtn').disabled = false;
        
        // Add retry handler
        document.getElementById('statusBanner').onclick = () => {
            document.getElementById('statusBanner').onclick = null;
            finishSession();
        };
        
        alert("Could not save data. Please check:\n1. Internet connection\n2. Google Apps Script URL\n\nTap the banner to retry.");
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        document.getElementById('sessionCount').innerText = "Qty: " + sessionHistory.length;
        list.innerHTML = [...sessionHistory].reverse().map((id, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #334155;">
                <span style="font-weight:bold; letter-spacing:1px; color: #e2e8f0;">${id}</span>
                <button class="delete-btn" onclick="removeItem(${i})">DELETE</button>
            </div>
        `).join('');
        if(sessionHistory.length > 0) list.style.display = 'block';
    }

    function removeItem(i) {
        const actualIndex = sessionHistory.length - 1 - i;
        sessionHistory.splice(actualIndex, 1);
        renderHistory();
        if (sessionHistory.length === 0) {
            document.getElementById('historyList').style.display = 'none';
            updateBanner("READY TO SCAN IPADS", "status-waiting");
        }
    }

    function setMode(m) { 
        mode = m; 
        resetApp(); 
        document.getElementById('btnBorrow').classList.toggle('active', m==='borrow'); 
        document.getElementById('btnReturn').classList.toggle('active', m==='return'); 
        syncBorrowedList(); 
    }

    function toggleHistory() { 
        const l = document.getElementById('historyList'); 
        if (sessionHistory.length > 0) {
            l.style.display = l.style.display==='none'?'block':'none'; 
        }
    }

    function updateBanner(t, c) { 
        const b = document.getElementById('statusBanner'); 
        b.innerText = t; 
        b.className = "status-banner " + c; 
        if (DEBUG_MODE) console.log('Banner:', t);
    }

    function resetApp() { 
        userId = null; 
        sessionHistory = []; 
        isProcessing = false; 
        document.getElementById('finishBtn').disabled = false; 
        document.getElementById('userPanel').style.display = 'none'; 
        document.getElementById('historyList').style.display = 'none'; 
        renderHistory(); 
        updateBanner("STEP 1: SCAN USER ID", "status-waiting"); 
    }

    // Initialize on page load
    window.addEventListener('load', () => {
        if (DEBUG_MODE) console.log('Page loaded, initializing...');
        startScanner();
        
        // Initialize audio context on first user interaction (iOS requirement)
        document.body.addEventListener('touchstart', initAudioContext, { once: true });
        document.body.addEventListener('click', initAudioContext, { once: true });
    });
</script>
</body>
</html>
